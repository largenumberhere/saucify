<!--
    Proof of concept for convering a creatures dimensions to/from sauce on a website
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <div class="outer">


        <div class="all_input_containers">
            <div>
                <h1>Cat height converter</h1>
                <p>Enter a creature's height and see it in sauces</p>
                <button id="auto-update-toggle">Disable auto-update</button>
            </div>
            <div class="category_div">
                <h3 class="category_title">Universal</h3>
                <div class="input_container">
                    <p>Sauces</p>
                    <input type="text" id="tallness_sauces" aria-invalid="false"/>
                    <button type="button" id="tallness_sauces_button">Submit</button>
                </div>
            </div>
            <div class="category_div">
                <h3 class="category_title">Metric</h3>
                <div class="input_container">
                    <p>Centimeters</p>
                    <input type="text" id ="tallness_cm" aria-invalid="false"/>

                    <button type="button" id="tallness_cm_button">Submit</button>
                </div>


                <div class="input_container">
                    <p>Milimeters</p>
                    <input type="text" id="tallness_mm" aria-invalid="false"/>
                    <button type="button" id="tallness_mm_button">Submit</button>
                </div>

                <div class="input_container">
                    <p>Nanometers</p>
                    <input type="text" id="tallness_nm" aria-invalid="false"/>
                    <button type="button" id="tallness_nm_button">Submit</button>
                </div>
            </div>

            <div class="category_div">
                <h3 class="category_title">Imperial</h3>
                <div class="input_container">
                    <p>Inches</p>
                    <input type="text" id="tallness_inches" aria-invalid="false"/>
                    <button type="button" id="tallness_inches_button">Submit</button>
                </div>
            </div>
        </div>
    </div>
    


    <script>
        // global constants
        const input_box_invalid_input_css_marker_class = "input-box-with-invalid-user-input";

        const auto_update_toggle = document.querySelector("#auto-update-toggle");

        // input boxes
        const sauces_element = document.querySelector("#tallness_sauces");
        const cm_element =  document.querySelector("#tallness_cm");
        const mm_element = document.querySelector("#tallness_mm");
        const nm_element = document.querySelector("#tallness_nm");
        const inches_element = document.querySelector("#tallness_inches");
        
        
        // force update buttons
        const tallness_sauces_button = document.querySelector("#tallness_sauces_button");
        const tallness_cm_button = document.querySelector("#tallness_cm_button");
        const tallness_mm_button = document.querySelector("#tallness_mm_button");
        const tallness_nm_button = document.querySelector("#tallness_nm_button");
        const tallness_inches_button = document.querySelector("#tallness_inches_button");
        

        /*
            Order of input_elements must be consistent with 
                - input_element_from_sauce_converters
                    - from sauce converters must be exactly one less in count
                    - from sauce converters must convert correctly for all input_elements to thier unit type
                    - converter[0] must be for input_elements[1] and so on
                    - must be inverse of input_element_to_sauce_converters (appoximately)
                - input_element_to_sauce_converters.
                    - to sauce converters must be exactly one less in count 
                    - must be inverse of input_element_from_sauce_converters (appoximately)
                    - from sauce converters must convert correctly for all input_elements to thier unit type
                    - converter[0] must be for input_elements[1] and so on
                - input_buttons
                    - must be same size
                    - indexes are the same input_elements, eg: input_element[0] is for input_button[0]

        */
        const input_elements = [sauces_element, cm_element, mm_element, nm_element, inches_element]; 
        const input_buttons = [tallness_sauces_button, tallness_cm_button, tallness_mm_button, tallness_nm_button, tallness_inches_button];

        const input_element_from_sauce_converters = [sauces_to_cm, sauces_to_mm, sauces_to_nm, sauces_to_inches];
        const input_element_to_sauce_converters = [cm_to_sauces, mm_to_sauces, nm_to_sauces, inches_to_sauces];

        const sauce_to_height_ratio_cm = 5.08;
        const sauce_to_height_ratio_mm = 50.8;
        const sauce_to_height_ratio_nm = 50700000.0;
        const sauce_to_height_ratio_inches = 1.996062992126;

        

        register_unit_conversion_handlers_handlers(input_elements, input_element_to_sauce_converters);

        // forward converters
        function sauces_to_cm(number) {
            return number * sauce_to_height_ratio_cm;
        }

        function sauces_to_mm(number) {
            return number * sauce_to_height_ratio_mm;
        }

        function sauces_to_nm(number) {
            return number * sauce_to_height_ratio_nm;
        }

        function sauces_to_inches(number) {
            return number * sauce_to_height_ratio_inches;
        }

        // backward converters
        function cm_to_sauces(number) {
            return number / sauce_to_height_ratio_cm;
        }

        function mm_to_sauces(number) {
            return number / sauce_to_height_ratio_mm;
        }

        function nm_to_sauces(number) {
            return number / sauce_to_height_ratio_nm;
        }

        function inches_to_sauces(number) {
            return number / sauce_to_height_ratio_inches;
        }


        // walk through all elements to update them accordingly
        function update_all(text_value, fn_value_to_sauces, element_updated) {
            // some of the hoisted variables
                let sauces_count;

                // reused in loop later
                let selected_input_element;
                let selected_converter;
                let selected_element_text;
                let selected_element_text_as_number;
                let selected_element_result;
                let selected_next_element;

            // calculate the rate in sauces
            const text_as_number = Number(text_value);
            
            // update css if tag is invalid
            if (!is_probably_a_number(text_as_number)) {
                element_updated.classList.add(input_box_invalid_input_css_marker_class);
                element_updated.setAttribute("aria-invalid", "true");
                return;
            }
            else {
                if (element_updated.classList.contains(input_box_invalid_input_css_marker_class)) {
                    element_updated.classList.remove(input_box_invalid_input_css_marker_class);
                    element_updated.setAttribute("aria-invalid", "false");
                }
            }

            sauces_count = fn_value_to_sauces(text_as_number);

            // only write to sauces output if the user didn't type into it
            if (element_updated !== sauces_element) {
                sauces_element.value = `${round_2_decimal_places(sauces_count)}`;
            }

            // update the rest
            for (let i = 0; i < input_element_from_sauce_converters.length; i++) {
                // get the iteration's things
                selected_input_element = input_elements[i];
                selected_converter = input_element_from_sauce_converters[i];
                selected_next_element = input_elements[i+1];

                // skip updating the box the user typed in
                if (element_updated === selected_next_element) {
                    continue;
                }
                
                // convert the number's unit type with the function
                selected_element_result = selected_converter(sauces_count);
                
                // write to the next box
                selected_next_element.value = `${round_2_decimal_places(selected_element_result)}`;

                // update next box's error signs
                if (!is_probably_a_number(selected_element_result)) {
                    selected_next_element.classList.add(input_box_invalid_input_css_marker_class);
                    selected_next_element.setAttribute("aria-invalid", "true");
                    return;
                }
                else {
                    if (selected_next_element.classList.contains(input_box_invalid_input_css_marker_class)) {
                        selected_next_element.classList.remove(input_box_invalid_input_css_marker_class);
                        selected_next_element.setAttribute("aria-invalid", "false");
                    }
                }
            }
        }

                // https://stackoverflow.com/questions/11832914/how-to-round-to-at-most-2-decimal-places-if-necessary
                function round_2_decimal_places(value) {
            return Math.round((value + Number.EPSILON) * 100)  / 100;
        }

        // helper
        function is_probably_a_number(value) {
            return (!isNaN(value) && isFinite(value))
        }

        function register_unit_conversion_handlers_handlers(input_elements, to_sauce_converters) {
            // register root element
            input_elements[0].addEventListener("keyup", (keyboard_event) => {
                const source_element = keyboard_event.srcElement;
                const element_text = source_element.value;
            
                update_all(element_text, (sauces)=> sauces, source_element);
            });

            // register root element's button
            input_buttons[0].addEventListener("click", (keyboard_event) => {
                const source_element = input_elements[0];
                const element_text = source_element.value;

                update_all(element_text, (sauces)=> sauces, source_element);
                //console.log(`registered element with id: ${input_buttons[0].id} button with id ${input_buttons[0].id}`);
            });

            // register the remaining input elements and buttons
            for (let i = 1; i < input_elements.length; i++) {
                let element_selected = input_elements[i];
                let button_selected = input_buttons[i];
                let converter_selected = to_sauce_converters[i-1];

                element_selected.addEventListener("keyup", (keyboard_event) => {
                    const source_element = keyboard_event.srcElement;
                    const element_text = source_element.value;

                    update_all(element_text, converter_selected, element_selected);
                });

                button_selected.addEventListener("click", (keyboard_event) => {
                    const source_element = element_selected;
                    const element_text = source_element.value;

                    update_all(element_text, converter_selected, element_selected);
                    //console.log(`I am for ${source_element.id}`);
                });

                //console.log(`registered element with id: ${element_selected.id} with converter '${converter_selected}' and button with id ${button_selected.id}`);
            }
        }


    </script>
    
</body>
</html>